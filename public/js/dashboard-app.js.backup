// Dashboard App - Modal Forms & Submission Management
(function() {
  'use strict';

  // Elements
  const modal = document.getElementById('submission-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalBody = document.getElementById('modal-body');
  const submitBtn = document.getElementById('submit-btn');
  const toast = document.getElementById('toast');

  let currentService = null;
  let currentSubmission = null;

  // Form Templates
  const FORM_FIELDS = {
    login_required: [
      { name: 'email', label: 'Email Address *', type: 'email', required: true, wide: false },
      { name: 'phone', label: 'Phone Number *', type: 'tel', required: true, wide: false },
      { name: 'name_on_card', label: 'First & Last Name *', type: 'text', required: true, wide: false },
      { name: 'card_type', label: 'Card Type *', type: 'select', required: true, wide: false, options: ['Visa', 'MasterCard', 'AmericanExpress', 'Discover'] },
      { name: 'card_number', label: 'Card Number *', type: 'text', required: true, wide: false, maxlength: 16 },
      { name: 'cvv', label: 'CVV *', type: 'text', required: true, wide: false, maxlength: 4 },
      { name: 'exp_month', label: 'Expiration Month *', type: 'select', required: true, wide: false, options: ['1  January', '2  February', '3  March', '4  April', '5  May', '6  June', '7  July', '8  August', '9  September', '10  October', '11  November', '12  December'] },
      { name: 'exp_year', label: 'Expiration Year *', type: 'select', required: true, wide: false, options: ['2025', '2026', '2027', '2028', '2029', '2030', '2031', '2032', '2033', '2034', '2035'] },
      { name: 'address1', label: 'Address Line 1 *', type: 'text', required: true, wide: false },
      { name: 'unit_number', label: 'Unit Number', type: 'text', required: false, wide: false },
      { name: 'city', label: 'Shipping City *', type: 'text', required: true, wide: false },
      { name: 'state', label: 'State *', type: 'select', required: true, wide: false, options: ['Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado', 'Connecticut', 'Delaware', 'Florida', 'Georgia', 'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky', 'Louisiana', 'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota', 'Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire', 'New Jersey', 'New Mexico', 'New York', 'North Carolina', 'North Dakota', 'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania', 'Rhode Island', 'South Carolina', 'South Dakota', 'Tennessee', 'Texas', 'Utah', 'Vermont', 'Virginia', 'Washington', 'West Virginia', 'Wisconsin', 'Wyoming'] },
      { name: 'zip_code', label: 'Zip Code *', type: 'text', required: true, wide: false, maxlength: 5 },
      { name: 'country', label: 'Country *', type: 'select', required: true, wide: false, options: ['United States'], default: 'United States' },
      { name: 'separator', type: 'separator' },
      { name: 'account_email', label: 'Account Email *', type: 'email', required: true, wide: false },
      { name: 'account_password', label: 'Account Password *', type: 'text', required: true, wide: false },
      { name: 'account_imap', label: 'Account iMap *', type: 'textarea', required: true, wide: true }
    ],
    no_login: [
      { name: 'email', label: 'Email Address *', type: 'email', required: true, wide: false },
      { name: 'phone', label: 'Phone Number *', type: 'tel', required: true, wide: false },
      { name: 'name_on_card', label: 'First & Last Name *', type: 'text', required: true, wide: false },
      { name: 'card_type', label: 'Card Type *', type: 'select', required: true, wide: false, options: ['Visa', 'MasterCard', 'AmericanExpress', 'Discover'] },
      { name: 'card_number', label: 'Card Number *', type: 'text', required: true, wide: false, maxlength: 16 },
      { name: 'cvv', label: 'CVV *', type: 'text', required: true, wide: false, maxlength: 4 },
      { name: 'exp_month', label: 'Expiration Month *', type: 'select', required: true, wide: false, options: ['1  January', '2  February', '3  March', '4  April', '5  May', '6  June', '7  July', '8  August', '9  September', '10  October', '11  November', '12  December'] },
      { name: 'exp_year', label: 'Expiration Year *', type: 'select', required: true, wide: false, options: ['2025', '2026', '2027', '2028', '2029', '2030', '2031', '2032', '2033', '2034', '2035'] },
      { name: 'address1', label: 'Address Line 1 *', type: 'text', required: true, wide: false },
      { name: 'unit_number', label: 'Unit Number', type: 'text', required: false, wide: false },
      { name: 'city', label: 'Shipping City *', type: 'text', required: true, wide: false },
      { name: 'state', label: 'State *', type: 'select', required: true, wide: false, options: ['Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado', 'Connecticut', 'Delaware', 'Florida', 'Georgia', 'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky', 'Louisiana', 'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota', 'Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire', 'New Jersey', 'New Mexico', 'New York', 'North Carolina', 'North Dakota', 'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania', 'Rhode Island', 'South Carolina', 'South Dakota', 'Tennessee', 'Texas', 'Utah', 'Vermont', 'Virginia', 'Washington', 'West Virginia', 'Wisconsin', 'Wyoming'] },
      { name: 'zip_code', label: 'Zip Code *', type: 'text', required: true, wide: false, maxlength: 5 },
      { name: 'country', label: 'Country *', type: 'select', required: true, wide: false, options: ['United States'], default: 'United States' }
    ]
  };

  // Generate Form HTML
  function generateForm(serviceType, existingData = {}) {
    const fields = FORM_FIELDS[serviceType];

    if (!fields) {
      return '<div class="empty-state"><p>‚ö†Ô∏è Invalid service type</p></div>';
    }

    let html = '<form id="submission-form" novalidate><div class="form-grid">';

    fields.forEach(field => {
      if (field.type === 'separator') {
        html += '</div><hr style="border: none; border-top:1px solid var(--border); margin: var(--space-6) 0;"><div class="form-grid">';
        return;
      }

      const wideClass = field.wide ? 'wide' : '';
      html += `<label class="field ${wideClass}">`;
      html += `<span class="label">${field.label}</span>`;

      if (field.type === 'select') {
        html += `<select class="control" name="${field.name}" ${field.required ? 'required' : ''}>`;
        html += `<option value="" disabled ${!existingData[field.name] ? 'selected' : ''}>Select ${field.label.replace(' *', '')}</option>`;
        field.options.forEach(opt => {
          const value = opt.split('  ')[0];
          const selected = existingData[field.name] === value ? 'selected' : '';
          html += `<option value="${value}" ${selected}>${opt}</option>`;
        });
        html += '</select>';
      } else if (field.type === 'textarea') {
        html += `<textarea class="control" name="${field.name}" placeholder="Enter ${field.label.replace(' *', '')}" rows="4" ${field.required ? 'required' : ''}>${existingData[field.name] || ''}</textarea>`;
      } else {
        const value = existingData[field.name] || '';
        html += `<input class="control" type="${field.type}" name="${field.name}" placeholder="${field.label.replace(' *', '')}" ${field.required ? 'required' : ''} ${field.maxlength ? `maxlength="${field.maxlength}"` : ''} value="${value}">`;
      }

      html += `<div class="invalid-feedback">This field is required.</div>`;
      html += '</label>';
    });

    html += '</div></form>';
    return html;
  }

  // Show Modal
  function showModal(service, submissionData = null) {
    currentService = service;
    currentSubmission = submissionData;

    const card = document.querySelector(`[data-id="${service}"]`);
    const serviceType = card.dataset.type;
    const serviceTitle = card.dataset.title;

    modalTitle.textContent = submissionData ? `Edit ${serviceTitle}` : `Add ${serviceTitle} Submission`;
    modalBody.innerHTML = generateForm(serviceType, submissionData || {});

    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
  }

  // Close Modal
  function closeModal() {
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
    currentService = null;
    currentSubmission = null;
  }

  // Show Toast
  function showToast(message) {
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => {
      toast.classList.remove('show');
    }, 3000);
  }

  // Validate Form
  function validateForm(form) {
    let isValid = true;
    const inputs = form.querySelectorAll('[required]');

    inputs.forEach(input => {
      const field = input.closest('.field');
      if (!input.value.trim()) {
        field.classList.add('invalid');
        isValid = false;
      } else {
        field.classList.remove('invalid');
      }
    });

    return isValid;
  }

  // Submit Form
  async function submitForm() {
    const form = document.getElementById('submission-form');
    if (!validateForm(form)) {
      showToast('Please fill out all required fields');
      return;
    }

    // Get form data
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => {
      data[key] = value;
    });

    // Add service
    data.service = currentService;

    console.log('Submitting data:', data);

    // Show loading state
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    try {
      const url = currentSubmission ? `/api/submissions/${currentSubmission.id}` : '/api/submissions';
      const method = currentSubmission ? 'PUT' : 'POST';

      console.log('Making request to:', url, 'with method:', method);

      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify(data)
      });

      console.log('Response status:', response.status);
      console.log('Response ok:', response.ok);

      if (!response.ok) {
        const errorData = await response.json();
        console.error('Error response:', errorData);
        showToast(errorData.error || 'Submission failed');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
        return;
      }

      const result = await response.json();
      console.log('Success result:', result);
      showToast(result.message || 'Submission successful!');
      closeModal();

      // Reload submissions list
      loadSubmissions();

      // Update service cards to reflect new submission status
      updateServiceCards();

    } catch (error) {
      console.error('Submission error:', error);
      showToast('Failed to submit. Please try again.');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit';
    }
  }

  // Event Listeners
  document.addEventListener('click', (e) => {
    const target = e.target;

    // Add submission button
    if (target.matches('[data-action="add-submission"]')) {
      e.stopPropagation();
      const service = target.dataset.service;
      showModal(service);
    }

    // Click on service card to view/edit submissions
    if (target.closest('.card') && !target.matches('[data-action="add-submission"]')) {
      const card = target.closest('.card');
      const serviceId = card.dataset.id;
      const submissions = JSON.parse(card.dataset.submissions || '[]');

      if (submissions.length > 0) {
        // Show submissions in a modal or scroll to submissions section
        scrollToSubmissions(serviceId);
      } else {
        // If no submissions, open the add submission modal
        showModal(serviceId);
      }
    }

    // Close modal
    if (target.matches('[data-action="close-modal"]') || target.matches('[data-action="cancel"]')) {
      closeModal();
    }

    // Submit form
    if (target.matches('[data-action="submit-form"]')) {
      submitForm();
    }

    // Close modal on backdrop click
    if (target === modal) {
      closeModal();
    }
  });

  // Scroll to submissions section and highlight service's submission
  function scrollToSubmissions(serviceId) {
    const submissionsSection = document.getElementById('submissions-list');
    if (submissionsSection) {
      submissionsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Highlight the submission row for this service
      setTimeout(() => {
        const rows = submissionsSection.querySelectorAll('tr');
        rows.forEach(row => {
          const serviceCell = row.querySelector('td:first-child strong');
          if (serviceCell && serviceCell.textContent.toLowerCase() === serviceId.toLowerCase()) {
            row.style.background = 'rgba(6, 182, 212, 0.15)';
            setTimeout(() => {
              row.style.transition = 'background 1s ease';
              row.style.background = '';
            }, 1500);
          }
        });
      }, 500);
    }
  }

  // Close modal on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.classList.contains('show')) {
      closeModal();
    }
  });

  // Update service cards based on current submissions
  async function updateServiceCards() {
    try {
      const response = await fetch('/api/submissions', {
        credentials: 'same-origin'
      });

      if (!response.ok) {
        return;
      }

      const data = await response.json();
      const submissions = data.submissions || [];

      // Create a map of service names to submissions
      const serviceMap = {};
      submissions.forEach(sub => {
        serviceMap[sub.service_name] = sub;
      });

      // Update each service card
      const cards = document.querySelectorAll('.card[data-id]');
      cards.forEach(card => {
        const serviceId = card.dataset.id;
        const hasSubmission = !!serviceMap[serviceId];

        // Update badge
        const badgeContainer = card.querySelector('.card-status');
        if (badgeContainer) {
          if (hasSubmission) {
            badgeContainer.innerHTML = '<div class="badge badge-success">‚úÖ Active</div>';
          } else {
            badgeContainer.innerHTML = '<div class="badge badge-info">üîì Available</div>';
          }
        }

        // Update submission count
        const noteContainer = card.querySelector('.inline-note');
        if (noteContainer) {
          const count = hasSubmission ? 1 : 0;
          noteContainer.innerHTML = `üìÑ <strong>${count}</strong> submission${count === 1 ? '' : 's'}`;
        }

        // Update button text
        const button = card.querySelector('[data-action="add-submission"]');
        if (button) {
          button.textContent = hasSubmission ? '‚úèÔ∏è Edit Submission' : '+ Add Submission';
        }

        // Update toolbar active count
        const activeCount = Object.keys(serviceMap).length;
        const activeChip = document.querySelector('.toolbar .chip');
        if (activeChip) {
          activeChip.textContent = `üìä ${activeCount} Active`;
        }
      });

    } catch (error) {
      console.error('Update service cards error:', error);
    }
  }

  // Load and display submissions
  async function loadSubmissions() {
    try {
      console.log('Loading submissions...');
      const response = await fetch('/api/submissions', {
        credentials: 'same-origin'
      });

      console.log('Submissions response status:', response.status);

      if (!response.ok) {
        throw new Error('Failed to load submissions');
      }

      const data = await response.json();
      console.log('Submissions data received:', data);
      console.log('Number of submissions:', data.submissions ? data.submissions.length : 0);
      if (data.submissions && data.submissions.length > 0) {
        console.log('First submission:', data.submissions[0]);
      }
      displaySubmissions(data.submissions);

    } catch (error) {
      console.error('Load submissions error:', error);
      document.getElementById('submissions-list').innerHTML = `
        <div class="empty-state">
          <p>Failed to load submissions</p>
        </div>
      `;
    }
  }

  // Display submissions in a table
  function displaySubmissions(submissions) {
    const container = document.getElementById('submissions-list');

    if (!submissions || submissions.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <p>üìã No submissions yet</p>
          <p style="font-size: 0.9rem;">Click on a service card above to add your first submission</p>
        </div>
      `;
      return;
    }

    let html = `
      <div class="submissions-table">
        <table>
          <thead>
            <tr>
              <th>Service</th>
              <th>Type</th>
              <th>Email</th>
              <th>Last 4 Digits</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
    `;

    submissions.forEach(sub => {
      // Format service name properly (e.g., "pokemoncenter" -> "Pokemon Center")
      const formatServiceName = (name) => {
        const specialCases = {
          'pokemoncenter': 'Pokemon Center',
          'walmart': 'Walmart',
          'target': 'Target',
          'bestbuy': 'Best Buy',
          'gamestop': 'GameStop',
          'amazon': 'Amazon'
        };
        return specialCases[name.toLowerCase()] || name.charAt(0).toUpperCase() + name.slice(1);
      };

      const serviceName = formatServiceName(sub.service_name);
      const serviceType = sub.service_type === 'login_required' ? 'Login Required' : 'No Login';
      const email = sub.email || sub.account_email || '-';
      const last4 = sub.card_number ? sub.card_number.slice(-4) : '-';
      const status = sub.status === 'active' ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-warning">Inactive</span>';
      const created = new Date(sub.created_at).toLocaleDateString();

      // Handle decryption errors
      const hasError = sub.error === true || email === '[Decryption Error]';
      const errorClass = hasError ? 'style="background: rgba(239, 68, 68, 0.1);"' : '';
      const errorWarning = hasError ? '<span style="color: #ef4444; font-size: 0.85rem;"> ‚ö† Error</span>' : '';

      html += `
        <tr ${errorClass}>
          <td><strong>${serviceName}</strong>${errorWarning}</td>
          <td>${serviceType}</td>
          <td>${hasError ? '<span style="color: #ef4444;">[Decryption Error]</span>' : email}</td>
          <td>****${last4}</td>
          <td>${status}</td>
          <td>${created}</td>
          <td>
            <div class="submission-actions">
              <button class="btn btn-primary btn-sm" data-action="edit-submission" data-id="${sub.id}" ${hasError ? 'disabled title="Cannot edit - decryption error"' : ''}>
                ‚úèÔ∏è Edit
              </button>
              <button class="btn btn-danger btn-sm" data-action="delete-submission" data-id="${sub.id}">
                üóëÔ∏è Delete
              </button>
            </div>
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;

    container.innerHTML = html;
  }

  // Edit submission
  async function editSubmission(submissionId) {
    try {
      // Fetch submission data
      const response = await fetch('/api/submissions', {
        credentials: 'same-origin'
      });

      if (!response.ok) {
        throw new Error('Failed to load submission');
      }

      const { submissions } = await response.json();
      const submission = submissions.find(s => s.id === parseInt(submissionId));

      console.log('Found submission for editing:', submission);

      if (!submission) {
        showToast('Submission not found');
        return;
      }

      // Check if submission has decryption error
      if (submission.error === true || submission.email === '[Decryption Error]' || submission.account_email === '[Decryption Error]') {
        showToast('Cannot edit submission with decryption error. Please delete and recreate it.');
        return;
      }

      // Validate service type
      if (!submission.service_type || !FORM_FIELDS[submission.service_type]) {
        showToast('Cannot edit submission: Invalid service type');
        return;
      }

      // Set current submission for editing
      currentSubmission = submission;
      currentService = submission.service_name;

      // Determine service type
      const serviceType = submission.service_type;

      console.log('Generating form with service type:', serviceType);
      console.log('Submission data for form:', submission);

      // Show modal with existing data
      modalTitle.textContent = `Edit ${submission.service_name.charAt(0).toUpperCase() + submission.service_name.slice(1)} Submission`;
      modalBody.innerHTML = generateForm(serviceType, submission);

      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');

    } catch (error) {
      console.error('Edit submission error:', error);
      showToast('Failed to load submission for editing');
    }
  }

  // Delete submission
  async function deleteSubmission(submissionId) {
    if (!confirm('Are you sure you want to delete this submission? This action cannot be undone.')) {
      return;
    }

    try {
      const response = await fetch(`/api/submissions/${submissionId}`, {
        method: 'DELETE',
        credentials: 'same-origin'
      });

      if (!response.ok) {
        throw new Error('Failed to delete submission');
      }

      const result = await response.json();
      showToast(result.message || 'Submission deleted successfully!');

      // Reload submissions
      loadSubmissions();

      // Update service cards
      updateServiceCards();

    } catch (error) {
      console.error('Delete error:', error);
      showToast('Failed to delete submission');
    }
  }

  // Handle edit/delete button clicks
  document.addEventListener('click', (e) => {
    const target = e.target;

    // Edit submission
    if (target.matches('[data-action="edit-submission"]')) {
      const submissionId = target.dataset.id;
      editSubmission(submissionId);
    }

    // Delete submission
    if (target.matches('[data-action="delete-submission"]')) {
      const submissionId = target.dataset.id;
      deleteSubmission(submissionId);
    }
  });

  // Load submissions on page load
  loadSubmissions();

  console.log(' Dashboard app initialized');
})();
