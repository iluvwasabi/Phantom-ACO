<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Service Submissions - <%= brandName || 'Phantom ACO' %> Admin</title>
  <link rel="stylesheet" href="/css/dashboard.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .tabs {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-6);
      border-bottom: 2px solid var(--border);
      overflow-x: auto;
    }
    .tab {
      padding: var(--space-3) var(--space-4);
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-weight: 600;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .tab:hover {
      color: var(--text-900);
    }
    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .submissions-table {
      font-size: 0.9rem;
    }
    .submissions-table table {
      width: 100%;
      table-layout: fixed;
    }
    .submissions-table th,
    .submissions-table td {
      padding: 12px 8px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .copy-cell {
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      cursor: pointer;
      padding: 8px 12px;
      position: relative;
      transition: background 0.2s ease;
    }
    .copy-cell:hover {
      background: rgba(96, 165, 250, 0.1);
    }
    .copy-cell:active {
      background: rgba(96, 165, 250, 0.2);
    }
    .badge {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-success {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }
    .submission-actions {
      display: flex;
      gap: 4px;
      justify-content: center;
    }
    .submission-actions .btn {
      padding: 4px 8px;
      font-size: 0.85rem;
      min-width: auto;
    }
    .bot-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      margin: 0;
    }
    .btn-danger {
      background: #ef4444;
      color: white;
      border: 1px solid #dc2626;
    }
    .btn-danger:hover {
      background: #dc2626;
      border-color: #b91c1c;
    }

    /* Enhanced tooltips for truncated text */
    .copy-cell[title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.95);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.875rem;
      white-space: pre-wrap;
      max-width: 400px;
      z-index: 1000;
      pointer-events: none;
      margin-bottom: 5px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      line-height: 1.4;
    }

    .copy-cell[title]:hover::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      pointer-events: none;
      margin-bottom: -1px;
    }

    .copy-cell {
      position: relative;
    }

    /* Make dialog scrollable */
    .dialog-body {
      max-height: 70vh;
      overflow-y: auto;
      padding: var(--space-6);
    }

    /* Visual separator for notes section */
    #edit-notes {
      margin-top: var(--space-2);
      border: 2px solid var(--primary);
      background: rgba(96, 165, 250, 0.05);
    }

    #edit-notes:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- Header -->
    <header class="header">
      <div class="header-inner">
        <div class="brand">
          <div class="brand-mark"></div>
          <span class="brand-name"><%= brandName || 'Phantom ACO' %></span>
          <span style="margin-left: 12px; padding: 4px 12px; background: rgba(239, 68, 68, 0.2); color: #ef4444; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">ADMIN</span>
        </div>
        <div class="header-actions">
          <a href="/admin" class="btn btn-ghost">Admin Home</a>
          <a href="/admin/users" class="btn btn-ghost">User Management</a>
          <a href="/dashboard" class="btn btn-ghost">User Dashboard</a>
          <a href="/auth/logout" class="btn btn-ghost">Logout</a>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="container">
      <div class="toolbar">
        <h1 class="title">Service Submissions</h1>
        <div style="color: var(--muted); font-size: 0.9rem; font-weight: 400;">
          üí° Click on any field to copy it
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <% servicePanels.forEach((panel, index) => { %>
          <button class="tab <%= index === 0 ? 'active' : '' %>" data-tab="<%= panel.service_id %>">
            <%= panel.icon ? panel.icon + ' ' : '' %><%= panel.service_name %> (<%= submissions[panel.service_id] ? submissions[panel.service_id].length : 0 %>)
          </button>
        <% }); %>
      </div>

      <!-- Target Tab -->
      <div id="target-tab" class="tab-content active">
        <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
          <div style="display: flex; gap: 12px; align-items: center;">
            <button onclick="selectAllCheckboxes('target-table')" class="btn btn-ghost" style="padding: 8px 12px;">‚úÖ Select All</button>
            <button onclick="deselectAllCheckboxes('target-table')" class="btn btn-ghost" style="padding: 8px 12px;">‚ùå Deselect All</button>
          </div>
          <div style="display: flex; gap: 12px;">
            <button onclick="exportSelectedToPrism('target-table')" class="btn btn-primary">üì¶ Export Selected to Prism JSON</button>
            <a href="/admin/export/excel" class="btn btn-primary" style="text-decoration: none;">üì• Export to Excel</a>
          </div>
        </div>
        <div class="submissions-table">
          <table id="target-table">
            <thead>
              <tr>
                <th style="width: 40px;"><input type="checkbox" class="select-all-checkbox" onclick="toggleAllCheckboxes('target-table', this)" style="width: 18px; height: 18px; cursor: pointer;"></th>
                <th>Assigned To</th>
                <th>ID</th>
                <th>Username</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Account Email</th>
                <th>Account Password</th>
                <th>iMap</th>
                <th>Card Type</th>
                <th>Card #</th>
                <th>Exp</th>
                <th>CVC</th>
                <th>Phone</th>
                <th>Max Qty</th>
                <th>Max Checkouts</th>
                <th>Notes</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (submissions.target.length > 0) { %>
                <% submissions.target.forEach(sub => { %>
                  <tr data-submission-id="<%= sub.id %>">
                    <td style="text-align: center;">
                      <input type="checkbox" class="submission-checkbox" value="<%= sub.id %>" style="width: 18px; height: 18px; cursor: pointer;">
                    </td>
                    <td style="text-align: center;">
                      <select class="assignment-dropdown" data-submission-id="<%= sub.id %>" style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-100); color: var(--text-900); font-size: 0.85rem;">
                        <option value="">Unassigned</option>
                        <option value="Desi" <%= sub.assigned_to === 'Desi' ? 'selected' : '' %>>Desi</option>
                        <option value="Ivan" <%= sub.assigned_to === 'Ivan' ? 'selected' : '' %>>Ivan</option>
                      </select>
                    </td>
                    <td><%= sub.id %></td>
                    <td><strong><%= sub.discord_username %></strong></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.first_name || '' %>', this)"><%= sub.first_name || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.last_name || '' %>', this)"><%= sub.last_name || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.account_email || '' %>', this)"><%= sub.account_email || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.account_password || '' %>', this)"><%= sub.account_password ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.account_imap || '' %>', this)"><%= sub.account_imap ? (sub.account_imap.length > 20 ? sub.account_imap.substring(0, 20) + '...' : sub.account_imap) : 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.card_type || '' %>', this)"><%= sub.card_type || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.card_number || '' %>', this)"><%= sub.card_number ? '****' + sub.card_number.slice(-4) : 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.exp_month %>/<%= sub.exp_year %>', this)"><%= sub.exp_month %>/<%= sub.exp_year %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.cvv || '' %>', this)"><%= sub.cvv || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.phone || '' %>', this)"><%= sub.phone || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.max_qty || '' %>', this)"><%= sub.max_qty || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.max_checkouts || '' %>', this)"><%= sub.max_checkouts || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.notes || '' %>', this)" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="<%= sub.notes || '' %>"><%= sub.notes || 'N/A' %></td>
                    <td><%= new Date(sub.created_at).toLocaleDateString() %></td>
                    <td>
                      <div class="submission-actions">
                        <button class="btn btn-sm btn-primary" onclick="editSubmission(<%= sub.id %>)" title="Edit Submission">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSubmission(<%= sub.id %>)" title="Delete Submission">üóëÔ∏è</button>
                      </div>
                    </td>
                  </tr>
                <% }); %>
              <% } else { %>
                <tr>
                  <td colspan="18" style="text-align: center; padding: var(--space-8); color: var(--muted);">
                    No Target submissions yet
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Walmart Tab -->
      <div id="walmart-tab" class="tab-content">
        <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
          <div style="display: flex; gap: 12px; align-items: center;">
            <button onclick="selectAllCheckboxes('walmart-table')" class="btn btn-ghost" style="padding: 8px 12px;">‚úÖ Select All</button>
            <button onclick="deselectAllCheckboxes('walmart-table')" class="btn btn-ghost" style="padding: 8px 12px;">‚ùå Deselect All</button>
          </div>
          <div style="display: flex; gap: 12px;">
            <button onclick="exportSelectedToPrism('walmart-table')" class="btn btn-primary">üì¶ Export Selected to Prism JSON</button>
            <a href="/admin/export/excel" class="btn btn-primary" style="text-decoration: none;">üì• Export to Excel</a>
          </div>
        </div>
        <div class="submissions-table">
          <table id="walmart-table">
            <thead>
              <tr>
                <th style="width: 40px;"><input type="checkbox" class="select-all-checkbox" onclick="toggleAllCheckboxes('walmart-table', this)" style="width: 18px; height: 18px; cursor: pointer;"></th>
                <th>Assigned To</th>
                <th>ID</th>
                <th>Username</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Account Email</th>
                <th>Account Password</th>
                <th>iMap</th>
                <th>Card Type</th>
                <th>Card #</th>
                <th>Exp</th>
                <th>CVC</th>
                <th>Phone</th>
                <th>Max Qty</th>
                <th>Max Checkouts</th>
                <th>Notes</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (submissions.walmart.length > 0) { %>
                <% submissions.walmart.forEach(sub => { %>
                  <tr data-submission-id="<%= sub.id %>">
                    <td style="text-align: center;">
                      <input type="checkbox" class="submission-checkbox" value="<%= sub.id %>" style="width: 18px; height: 18px; cursor: pointer;">
                    </td>
                    <td style="text-align: center;">
                      <select class="assignment-dropdown" data-submission-id="<%= sub.id %>" style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-100); color: var(--text-900); font-size: 0.85rem;">
                        <option value="">Unassigned</option>
                        <option value="Desi" <%= sub.assigned_to === 'Desi' ? 'selected' : '' %>>Desi</option>
                        <option value="Ivan" <%= sub.assigned_to === 'Ivan' ? 'selected' : '' %>>Ivan</option>
                      </select>
                    </td>
                    <td><%= sub.id %></td>
                    <td><strong><%= sub.discord_username %></strong></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.first_name || '' %>', this)"><%= sub.first_name || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.last_name || '' %>', this)"><%= sub.last_name || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.account_email || '' %>', this)"><%= sub.account_email || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.account_password || '' %>', this)"><%= sub.account_password ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.account_imap || '' %>', this)"><%= sub.account_imap ? (sub.account_imap.length > 20 ? sub.account_imap.substring(0, 20) + '...' : sub.account_imap) : 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.card_type || '' %>', this)"><%= sub.card_type || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.card_number || '' %>', this)"><%= sub.card_number ? '****' + sub.card_number.slice(-4) : 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.exp_month %>/<%= sub.exp_year %>', this)"><%= sub.exp_month %>/<%= sub.exp_year %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.cvv || '' %>', this)"><%= sub.cvv || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.phone || '' %>', this)"><%= sub.phone || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.max_qty || '' %>', this)"><%= sub.max_qty || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.max_checkouts || '' %>', this)"><%= sub.max_checkouts || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.notes || '' %>', this)" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="<%= sub.notes || '' %>"><%= sub.notes || 'N/A' %></td>
                    <td><%= new Date(sub.created_at).toLocaleDateString() %></td>
                    <td>
                      <div class="submission-actions">
                        <button class="btn btn-sm btn-primary" onclick="editSubmission(<%= sub.id %>)" title="Edit Submission">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSubmission(<%= sub.id %>)" title="Delete Submission">üóëÔ∏è</button>
                      </div>
                    </td>
                  </tr>
                <% }); %>
              <% } else { %>
                <tr>
                  <td colspan="18" style="text-align: center; padding: var(--space-8); color: var(--muted);">
                    No Walmart submissions yet
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Best Buy Tab -->
      <div id="bestbuy-tab" class="tab-content">
        <div class="submissions-table">
          <table>
            <thead>
              <tr>
                <th>Assigned To</th>
                <th>ID</th>
                <th>Username</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Account Email</th>
                <th>Account Password</th>
                <th>iMap</th>
                <th>Card Type</th>
                <th>Card #</th>
                <th>Exp</th>
                <th>CVC</th>
                <th>Phone</th>
                <th>Max Qty</th>
                <th>Max Checkouts</th>
                <th>Notes</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (submissions.bestbuy.length > 0) { %>
                <% submissions.bestbuy.forEach(sub => { %>
                  <tr data-submission-id="<%= sub.id %>">
                    <td style="text-align: center;">
                      <select class="assignment-dropdown" data-submission-id="<%= sub.id %>" style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-100); color: var(--text-900); font-size: 0.85rem;">
                        <option value="">Unassigned</option>
                        <option value="Desi" <%= sub.assigned_to === 'Desi' ? 'selected' : '' %>>Desi</option>
                        <option value="Ivan" <%= sub.assigned_to === 'Ivan' ? 'selected' : '' %>>Ivan</option>
                      </select>
                    </td>
                    <td><%= sub.id %></td>
                    <td><strong><%= sub.discord_username %></strong></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.first_name || '' %>', this)"><%= sub.first_name || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.last_name || '' %>', this)"><%= sub.last_name || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.account_email || '' %>', this)"><%= sub.account_email || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.account_password || '' %>', this)"><%= sub.account_password ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.account_imap || '' %>', this)"><%= sub.account_imap ? (sub.account_imap.length > 20 ? sub.account_imap.substring(0, 20) + '...' : sub.account_imap) : 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.card_type || '' %>', this)"><%= sub.card_type || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.card_number || '' %>', this)"><%= sub.card_number ? '****' + sub.card_number.slice(-4) : 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.exp_month %>/<%= sub.exp_year %>', this)"><%= sub.exp_month %>/<%= sub.exp_year %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.cvv || '' %>', this)"><%= sub.cvv || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.phone || '' %>', this)"><%= sub.phone || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.max_qty || '' %>', this)"><%= sub.max_qty || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.max_checkouts || '' %>', this)"><%= sub.max_checkouts || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.notes || '' %>', this)" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="<%= sub.notes || '' %>"><%= sub.notes || 'N/A' %></td>
                    <td><%= new Date(sub.created_at).toLocaleDateString() %></td>
                    <td>
                      <div class="submission-actions">
                        <button class="btn btn-sm btn-primary" onclick="editSubmission(<%= sub.id %>)" title="Edit Submission">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSubmission(<%= sub.id %>)" title="Delete Submission">üóëÔ∏è</button>
                      </div>
                    </td>
                  </tr>
                <% }); %>
              <% } else { %>
                <tr>
                  <td colspan="18" style="text-align: center; padding: var(--space-8); color: var(--muted);">
                    No Best Buy submissions yet
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pokemon Center Tab -->
      <div id="pokemoncenter-tab" class="tab-content">
        <div class="submissions-table">
          <table>
            <thead>
              <tr>
                <th>Bot</th>
                <th>ID</th>
                <th>Username</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Email</th>
                <th>Card Type</th>
                <th>Card #</th>
                <th>Exp</th>
                <th>CVC</th>
                <th>Billing</th>
                <th>Shipping</th>
                <th>Phone</th>
                <th>Max Qty</th>
                <th>Max Checkouts</th>
                <th>Notes</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (submissions.pokemoncenter.length > 0) { %>
                <% submissions.pokemoncenter.forEach(sub => {
                  const billingFull = [sub.billing_address, sub.billing_city, sub.billing_state, sub.billing_zipcode].filter(v => v).join(', ');
                  const shippingFull = [sub.address1, sub.city, sub.state, sub.zip_code].filter(v => v).join(', ');
                %>
                  <tr data-submission-id="<%= sub.id %>">
                    <td style="text-align: center;">
                      <select class="assignment-dropdown" data-submission-id="<%= sub.id %>" style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-100); color: var(--text-900); font-size: 0.85rem;">
                        <option value="">Unassigned</option>
                        <option value="Desi" <%= sub.assigned_to === 'Desi' ? 'selected' : '' %>>Desi</option>
                        <option value="Ivan" <%= sub.assigned_to === 'Ivan' ? 'selected' : '' %>>Ivan</option>
                      </select>
                    </td>
                    <td><%= sub.id %></td>
                    <td><strong><%= sub.discord_username %></strong></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.first_name || '' %>', this)"><%= sub.first_name || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.last_name || '' %>', this)"><%= sub.last_name || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.email || '' %>', this)"><%= sub.email || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.card_type || '' %>', this)"><%= sub.card_type || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.card_number || '' %>', this)"><%= sub.card_number ? '****' + sub.card_number.slice(-4) : 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.exp_month %>/<%= sub.exp_year %>', this)"><%= sub.exp_month %>/<%= sub.exp_year %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.cvv || '' %>', this)"><%= sub.cvv || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= billingFull %>', this)"><%= billingFull || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= shippingFull %>', this)"><%= shippingFull || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.phone || '' %>', this)"><%= sub.phone || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.max_qty || '' %>', this)"><%= sub.max_qty || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.max_checkouts || '' %>', this)"><%= sub.max_checkouts || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.notes || '' %>', this)" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="<%= sub.notes || '' %>"><%= sub.notes || 'N/A' %></td>
                    <td><%= new Date(sub.created_at).toLocaleDateString() %></td>
                    <td>
                      <div class="submission-actions">
                        <button class="btn btn-sm btn-primary" onclick="editSubmission(<%= sub.id %>)" title="Edit Submission">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSubmission(<%= sub.id %>)" title="Delete Submission">üóëÔ∏è</button>
                      </div>
                    </td>
                  </tr>
                <% }); %>
              <% } else { %>
                <tr>
                  <td colspan="18" style="text-align: center; padding: var(--space-8); color: var(--muted);">
                    No Pokemon Center submissions yet
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Shopify Tab -->
      <div id="shopify-tab" class="tab-content">
        <div class="submissions-table">
          <table>
            <thead>
              <tr>
                <th>Bot</th>
                <th>ID</th>
                <th>Username</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Email</th>
                <th>Card Type</th>
                <th>Card #</th>
                <th>Exp</th>
                <th>CVC</th>
                <th>Billing</th>
                <th>Shipping</th>
                <th>Phone</th>
                <th>Max Qty</th>
                <th>Max Checkouts</th>
                <th>Notes</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (submissions.shopify.length > 0) { %>
                <% submissions.shopify.forEach(sub => {
                  const billingFull = [sub.billing_address, sub.billing_city, sub.billing_state, sub.billing_zipcode].filter(v => v).join(', ');
                  const shippingFull = [sub.address1, sub.city, sub.state, sub.zip_code].filter(v => v).join(', ');
                %>
                  <tr data-submission-id="<%= sub.id %>">
                    <td style="text-align: center;">
                      <select class="assignment-dropdown" data-submission-id="<%= sub.id %>" style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-100); color: var(--text-900); font-size: 0.85rem;">
                        <option value="">Unassigned</option>
                        <option value="Desi" <%= sub.assigned_to === 'Desi' ? 'selected' : '' %>>Desi</option>
                        <option value="Ivan" <%= sub.assigned_to === 'Ivan' ? 'selected' : '' %>>Ivan</option>
                      </select>
                    </td>
                    <td><%= sub.id %></td>
                    <td><strong><%= sub.discord_username %></strong></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.first_name || '' %>', this)"><%= sub.first_name || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.last_name || '' %>', this)"><%= sub.last_name || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.email || '' %>', this)"><%= sub.email || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.card_type || '' %>', this)"><%= sub.card_type || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.card_number || '' %>', this)"><%= sub.card_number ? '****' + sub.card_number.slice(-4) : 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.exp_month %>/<%= sub.exp_year %>', this)"><%= sub.exp_month %>/<%= sub.exp_year %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.cvv || '' %>', this)"><%= sub.cvv || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= billingFull %>', this)"><%= billingFull || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= shippingFull %>', this)"><%= shippingFull || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.phone || '' %>', this)"><%= sub.phone || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.max_qty || '' %>', this)"><%= sub.max_qty || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.max_checkouts || '' %>', this)"><%= sub.max_checkouts || 'N/A' %></td>
                    <td class="copy-cell" onclick="copyText('<%= sub.notes || '' %>', this)" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="<%= sub.notes || '' %>"><%= sub.notes || 'N/A' %></td>
                    <td><%= new Date(sub.created_at).toLocaleDateString() %></td>
                    <td>
                      <div class="submission-actions">
                        <button class="btn btn-sm btn-primary" onclick="editSubmission(<%= sub.id %>)" title="Edit Submission">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSubmission(<%= sub.id %>)" title="Delete Submission">üóëÔ∏è</button>
                      </div>
                    </td>
                  </tr>
                <% }); %>
              <% } else { %>
                <tr>
                  <td colspan="18" style="text-align: center; padding: var(--space-8); color: var(--muted);">
                    No Shopify submissions yet
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Dynamic tabs for services not hardcoded above -->
      <% servicePanels.forEach((panel, index) => { %>
        <% if (!['target', 'walmart', 'bestbuy', 'pokemoncenter', 'shopify'].includes(panel.service_id)) { %>
          <div id="<%= panel.service_id %>-tab" class="tab-content">
            <div style="margin-bottom: 16px; display: flex; justify-content: flex-end;">
              <a href="/admin/export/excel" class="btn btn-primary" style="text-decoration: none;">üì• Export to Excel</a>
            </div>
            <div class="submissions-table">
              <table>
                <thead>
                  <tr>
                    <th>Assigned To</th>
                    <th>ID</th>
                    <th>Username</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Account Email</th>
                    <th>Account Password</th>
                    <th>iMap</th>
                    <th>Card Type</th>
                    <th>Card #</th>
                    <th>Exp</th>
                    <th>CVC</th>
                    <th>Phone</th>
                    <th>Max Qty</th>
                    <th>Max Checkouts</th>
                    <th>Selected Products</th>
                    <th>Notes</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (submissions[panel.service_id] && submissions[panel.service_id].length > 0) { %>
                    <% submissions[panel.service_id].forEach(sub => { %>
                      <%
                        let productsDisplay = 'N/A';
                        if (sub.selected_products && sub.selected_products.length > 0) {
                          productsDisplay = sub.selected_products.map(p => `${p.product} (Qty: ${p.quantity}, CO: ${p.checkouts})`).join(', ');
                        }
                      %>
                      <tr data-submission-id="<%= sub.id %>">
                        <td style="text-align: center;">
                          <select class="assignment-dropdown" data-submission-id="<%= sub.id %>" style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-100); color: var(--text-900); font-size: 0.85rem;">
                            <option value="">Unassigned</option>
                            <option value="Desi" <%= sub.assigned_to === 'Desi' ? 'selected' : '' %>>Desi</option>
                            <option value="Ivan" <%= sub.assigned_to === 'Ivan' ? 'selected' : '' %>>Ivan</option>
                          </select>
                        </td>
                        <td><%= sub.id %></td>
                        <td><strong><%= sub.discord_username %></strong></td>
                        <td class="copy-cell" onclick="copyText('<%= sub.first_name || '' %>', this)"><%= sub.first_name || 'N/A' %></td>
                        <td class="copy-cell" onclick="copyText('<%= sub.last_name || '' %>', this)"><%= sub.last_name || 'N/A' %></td>
                        <td class="copy-cell" onclick="copyText('<%= sub.account_email || '' %>', this)"><%= sub.account_email || 'N/A' %></td>
                        <td class="copy-cell" onclick="copyText('<%= sub.account_password || '' %>', this)"><%= sub.account_password ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'N/A' %></td>
                        <td class="copy-cell" onclick="copyText('<%= sub.account_imap || '' %>', this)"><%= sub.account_imap ? (sub.account_imap.length > 20 ? sub.account_imap.substring(0, 20) + '...' : sub.account_imap) : 'N/A' %></td>
                        <td class="copy-cell" onclick="copyText('<%= sub.card_type || '' %>', this)"><%= sub.card_type || 'N/A' %></td>
                        <td class="copy-cell" onclick="copyText('<%= sub.card_number || '' %>', this)"><%= sub.card_number ? '****' + sub.card_number.slice(-4) : 'N/A' %></td>
                        <td class="copy-cell" onclick="copyText('<%= sub.exp_month %>/<%= sub.exp_year %>', this)"><%= sub.exp_month %>/<%= sub.exp_year %></td>
                        <td class="copy-cell" onclick="copyText('<%= sub.cvv || '' %>', this)"><%= sub.cvv || 'N/A' %></td>
                        <td class="copy-cell" onclick="copyText('<%= sub.phone || '' %>', this)"><%= sub.phone || 'N/A' %></td>
                        <td class="copy-cell" onclick="copyText('<%= sub.max_qty || '' %>', this)"><%= sub.max_qty || 'N/A' %></td>
                        <td class="copy-cell" onclick="copyText('<%= sub.max_checkouts || '' %>', this)"><%= sub.max_checkouts || 'N/A' %></td>
                            <td class="copy-cell" onclick="copyText('<%= sub.notes || '' %>', this)" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="<%= sub.notes || '' %>"><%= sub.notes || 'N/A' %></td>
                        <td><%= new Date(sub.created_at).toLocaleDateString() %></td>
                        <td>
                          <div class="submission-actions">
                            <button class="btn btn-sm btn-primary" onclick="editSubmission(<%= sub.id %>)" title="Edit Submission">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSubmission(<%= sub.id %>)" title="Delete Submission">üóëÔ∏è</button>
                          </div>
                        </td>
                      </tr>
                    <% }); %>
                  <% } else { %>
                    <tr>
                      <td colspan="19" style="text-align: center; padding: var(--space-8); color: var(--muted);">
                        No <%= panel.service_name %> submissions yet
                      </td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        <% } %>
      <% }); %>
    </div>
  </div>

  <!-- Edit Submission Modal -->
  <div id="edit-modal" class="modal" aria-hidden="true">
    <div class="dialog animate-in" role="dialog" aria-modal="true" style="max-width: 800px;">
      <div class="dialog-header">
        <h2 id="modal-title">Edit Submission</h2>
        <button class="icon-btn close-edit-modal" aria-label="Close">‚úï</button>
      </div>
      <div class="dialog-body">
        <form id="edit-submission-form" class="form-grid">
          <input type="hidden" id="edit-submission-id">
          <input type="hidden" id="edit-service-type">

          <div class="field">
            <label class="label">First Name</label>
            <input type="text" id="edit-first-name" class="control">
          </div>

          <div class="field">
            <label class="label">Last Name</label>
            <input type="text" id="edit-last-name" class="control">
          </div>

          <div class="field wide login-required-only">
            <label class="label">Account Email</label>
            <input type="email" id="edit-account-email" class="control">
          </div>

          <div class="field wide login-required-only">
            <label class="label">Account Password</label>
            <input type="text" id="edit-account-password" class="control">
          </div>

          <div class="field wide login-required-only">
            <label class="label">IMAP</label>
            <input type="text" id="edit-account-imap" class="control">
          </div>

          <div class="field wide">
            <label class="label">Email</label>
            <input type="email" id="edit-email" class="control">
          </div>

          <div class="field">
            <label class="label">Phone</label>
            <input type="tel" id="edit-phone" class="control">
          </div>

          <div class="field">
            <label class="label">Card Type</label>
            <select id="edit-card-type" class="control">
              <option value="">Select...</option>
              <option value="Mastercard">Mastercard</option>
              <option value="Visa">Visa</option>
              <option value="American Express">American Express</option>
              <option value="Discover">Discover</option>
            </select>
          </div>

          <div class="field">
            <label class="label">Card Number</label>
            <input type="text" id="edit-card-number" class="control">
          </div>

          <div class="field">
            <label class="label">Exp Month</label>
            <input type="text" id="edit-exp-month" class="control" placeholder="MM" maxlength="2">
          </div>

          <div class="field">
            <label class="label">Exp Year</label>
            <input type="text" id="edit-exp-year" class="control" placeholder="YY" maxlength="2">
          </div>

          <div class="field">
            <label class="label">CVV</label>
            <input type="text" id="edit-cvv" class="control" maxlength="4">
          </div>

          <div class="field wide">
            <label class="label">Billing Address</label>
            <input type="text" id="edit-billing-address" class="control">
          </div>

          <div class="field">
            <label class="label">Billing City</label>
            <input type="text" id="edit-billing-city" class="control">
          </div>

          <div class="field">
            <label class="label">Billing State</label>
            <input type="text" id="edit-billing-state" class="control" maxlength="2">
          </div>

          <div class="field">
            <label class="label">Billing Zipcode</label>
            <input type="text" id="edit-billing-zipcode" class="control">
          </div>

          <div class="field wide">
            <label class="label">Shipping Address</label>
            <input type="text" id="edit-shipping-address" class="control">
          </div>

          <div class="field">
            <label class="label">Shipping City</label>
            <input type="text" id="edit-shipping-city" class="control">
          </div>

          <div class="field">
            <label class="label">Shipping State</label>
            <input type="text" id="edit-shipping-state" class="control" maxlength="2">
          </div>

          <div class="field">
            <label class="label">Shipping Zipcode</label>
            <input type="text" id="edit-shipping-zipcode" class="control">
          </div>

          <div class="field">
            <label class="label">Max Quantity</label>
            <input type="number" id="edit-max-qty" class="control" min="1" max="99">
          </div>

          <div class="field">
            <label class="label">Max Checkouts</label>
            <input type="number" id="edit-max-checkouts" class="control" min="1" max="99">
          </div>

          <hr style="grid-column: 1 / -1; border: none; border-top: 2px solid var(--border); margin: var(--space-4) 0;">

          <div class="field wide">
            <label class="label" style="font-size: 1.1rem; font-weight: 600; color: var(--primary);">üìù Notes / Special Instructions</label>
            <textarea id="edit-notes" class="control" rows="6" placeholder="Enter any special instructions, preferences, or notes here..." style="font-size: 0.95rem;"></textarea>
          </div>
        </form>
      </div>
      <div class="dialog-footer">
        <button class="btn btn-ghost close-edit-modal">Cancel</button>
        <button class="btn btn-primary" id="save-submission-btn">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast" aria-live="polite"></div>

  <!-- Hidden textarea for copying -->
  <textarea id="copy-buffer" style="position: absolute; left: -9999px;"></textarea>

  <script>
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function copyText(text, element) {
      if (!text || text === 'N/A' || text === '') {
        showToast('No data to copy');
        return;
      }

      const textarea = document.getElementById('copy-buffer');
      textarea.value = text;
      textarea.select();
      document.execCommand('copy');

      element.style.background = 'rgba(16, 185, 129, 0.2)';
      setTimeout(() => {
        element.style.background = '';
      }, 300);

      showToast(`Copied: ${text.length > 30 ? text.substring(0, 30) + '...' : text}`);
    }

    // Edit submission
    async function editSubmission(id) {
      try {
        // Fetch submission data using admin API
        const response = await fetch(`/admin/api/submissions/${id}`, {
          credentials: 'same-origin'
        });

        if (!response.ok) {
          showToast('Failed to load submission data');
          return;
        }

        const submission = await response.json();

        // Populate form
        document.getElementById('edit-submission-id').value = submission.id;
        document.getElementById('edit-service-type').value = submission.service_type || '';
        document.getElementById('edit-first-name').value = submission.first_name || '';
        document.getElementById('edit-last-name').value = submission.last_name || '';

        // Show/hide login-required fields based on service type
        const isLoginRequired = submission.service_type === 'login_required';
        document.querySelectorAll('.login-required-only').forEach(field => {
          field.style.display = isLoginRequired ? '' : 'none';
        });
        document.getElementById('edit-account-email').value = submission.account_email || '';
        document.getElementById('edit-account-password').value = submission.account_password || '';
        document.getElementById('edit-account-imap').value = submission.account_imap || '';
        document.getElementById('edit-email').value = submission.email || '';
        document.getElementById('edit-phone').value = submission.phone || '';
        document.getElementById('edit-card-type').value = submission.card_type || '';
        document.getElementById('edit-card-number').value = submission.card_number || '';
        document.getElementById('edit-exp-month').value = submission.exp_month || '';
        document.getElementById('edit-exp-year').value = submission.exp_year || '';
        document.getElementById('edit-cvv').value = submission.cvv || '';
        document.getElementById('edit-billing-address').value = submission.billing_address || '';
        document.getElementById('edit-billing-city').value = submission.billing_city || '';
        document.getElementById('edit-billing-state').value = submission.billing_state || '';
        document.getElementById('edit-billing-zipcode').value = submission.billing_zipcode || '';
        document.getElementById('edit-shipping-address').value = submission.address1 || '';
        document.getElementById('edit-shipping-city').value = submission.city || '';
        document.getElementById('edit-shipping-state').value = submission.state || '';
        document.getElementById('edit-shipping-zipcode').value = submission.zip_code || '';
        document.getElementById('edit-max-qty').value = submission.max_qty || 1;
        document.getElementById('edit-max-checkouts').value = submission.max_checkouts || 1;
        document.getElementById('edit-notes').value = submission.notes || '';

        // Show modal
        document.getElementById('edit-modal').classList.add('show');
      } catch (error) {
        console.error('Edit error:', error);
        showToast('Error loading submission data');
      }
    }

    // Close modal
    document.querySelectorAll('.close-edit-modal').forEach(btn => {
      btn.addEventListener('click', () => {
        document.getElementById('edit-modal').classList.remove('show');
      });
    });

    // Save submission changes
    document.getElementById('save-submission-btn').addEventListener('click', async () => {
      const submissionId = document.getElementById('edit-submission-id').value;
      const serviceType = document.getElementById('edit-service-type').value;
      const isLoginRequired = serviceType === 'login_required';

      const data = {
        first_name: document.getElementById('edit-first-name').value,
        last_name: document.getElementById('edit-last-name').value,
        email: document.getElementById('edit-email').value,
        phone: document.getElementById('edit-phone').value,
        card_type: document.getElementById('edit-card-type').value,
        card_number: document.getElementById('edit-card-number').value,
        exp_month: document.getElementById('edit-exp-month').value,
        exp_year: document.getElementById('edit-exp-year').value,
        cvv: document.getElementById('edit-cvv').value,
        billing_address: document.getElementById('edit-billing-address').value,
        billing_city: document.getElementById('edit-billing-city').value,
        billing_state: document.getElementById('edit-billing-state').value,
        billing_zipcode: document.getElementById('edit-billing-zipcode').value,
        address1: document.getElementById('edit-shipping-address').value,
        city: document.getElementById('edit-shipping-city').value,
        state: document.getElementById('edit-shipping-state').value,
        zip_code: document.getElementById('edit-shipping-zipcode').value,
        max_qty: document.getElementById('edit-max-qty').value,
        max_checkouts: document.getElementById('edit-max-checkouts').value,
        notes: document.getElementById('edit-notes').value
      };

      // Only include login-required fields if service type requires login
      if (isLoginRequired) {
        data.account_email = document.getElementById('edit-account-email').value;
        data.account_password = document.getElementById('edit-account-password').value;
        data.account_imap = document.getElementById('edit-account-imap').value;
      }

      try {
        const response = await fetch(`/admin/api/submissions/${submissionId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
          showToast('Submission updated successfully!');
          document.getElementById('edit-modal').classList.remove('show');
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast('Failed to update submission');
        }
      } catch (error) {
        console.error('Save error:', error);
        showToast('Error updating submission');
      }
    });

    // Delete submission
    async function deleteSubmission(id) {
      if (!confirm('Are you sure you want to delete this submission?\n\nThis will permanently delete all submission data including encrypted credentials.\n\nThis action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`/admin/submissions/${id}`, {
          method: 'DELETE',
          credentials: 'same-origin'
        });

        const data = await response.json();

        if (data.success) {
          showToast('Submission deleted successfully');
          // Remove row from table
          const row = document.querySelector(`tr[data-submission-id="${id}"]`);
          if (row) {
            row.remove();
          }

          // Update tab counts after a short delay
          setTimeout(() => {
            location.reload();
          }, 1000);
        } else {
          showToast('Failed to delete submission');
        }
      } catch (error) {
        console.error('Delete error:', error);
        showToast('Error deleting submission');
      }
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;

        // Update active tab
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Update active content
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');
      });
    });

    // Bot checkbox toggle
    document.addEventListener('change', async (e) => {
      if (e.target.classList.contains('assignment-dropdown')) {
        const dropdown = e.target;
        const submissionId = dropdown.dataset.submissionId;
        const assignedTo = dropdown.value;
        const previousValue = dropdown.getAttribute('data-previous-value') || '';

        try {
          const response = await fetch(`/admin/api/submissions/${submissionId}/assign`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ assigned_to: assignedTo })
          });

          const result = await response.json();
          if (result.success) {
            dropdown.setAttribute('data-previous-value', assignedTo);
            if (assignedTo === '') {
              showToast('‚¨ú Unassigned from bot');
            } else {
              showToast(`‚úÖ Assigned to ${assignedTo}`);
            }
          } else {
            showToast('Failed to update assignment');
            // Revert dropdown on error
            dropdown.value = previousValue;
          }
        } catch (error) {
          console.error('Toggle bot error:', error);
          showToast('Error updating checkbox');
          // Revert checkbox on error
          checkbox.checked = !checkbox.checked;
        }
      }
    });

    // Checkbox selection functions
    function toggleAllCheckboxes(tableId, headerCheckbox) {
      const table = document.getElementById(tableId);
      const checkboxes = table.querySelectorAll('.submission-checkbox');
      checkboxes.forEach(cb => cb.checked = headerCheckbox.checked);
    }

    function selectAllCheckboxes(tableId) {
      const table = document.getElementById(tableId);
      const checkboxes = table.querySelectorAll('.submission-checkbox');
      checkboxes.forEach(cb => cb.checked = true);
      const headerCheckbox = table.querySelector('.select-all-checkbox');
      if (headerCheckbox) headerCheckbox.checked = true;
    }

    function deselectAllCheckboxes(tableId) {
      const table = document.getElementById(tableId);
      const checkboxes = table.querySelectorAll('.submission-checkbox');
      checkboxes.forEach(cb => cb.checked = false);
      const headerCheckbox = table.querySelector('.select-all-checkbox');
      if (headerCheckbox) headerCheckbox.checked = false;
    }

    // Export selected submissions to Prism format
    async function exportSelectedToPrism(tableId) {
      const table = document.getElementById(tableId);
      const checkboxes = table.querySelectorAll('.submission-checkbox:checked');
      const submissionIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

      if (submissionIds.length === 0) {
        showToast('Please select at least one submission to export');
        return;
      }

      try {
        const response = await fetch('/admin/export/prism', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ submissionIds })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Export failed');
        }

        // Download the file
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `prism-profiles-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showToast(`Exported ${submissionIds.length} profile(s) to Prism JSON`);
      } catch (error) {
        console.error('Export error:', error);
        showToast('Error exporting profiles: ' + error.message);
      }
    }
  </script>
</body>
</html>
